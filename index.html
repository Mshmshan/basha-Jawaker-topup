<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Basha Jawaker TopUp</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- المتغيرات الأساسية --- */
        :root { 
            --primary: #d4af37;        
            --primary-dim: rgba(212, 175, 55, 0.2);
            --bg-dark: #050505;
            --card-glass: rgba(18, 18, 18, 0.85);
            --border-light: rgba(255, 255, 255, 0.08);
            --text-grey: #8b9bb4;
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --transition-speed: 0.5s;
        }

        body.theme-red {
            --primary: #ff1717;
            --primary-dim: rgba(255, 23, 68, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background-color: var(--bg-dark); 
            color: white; 
            min-height: 100vh; 
            overflow-x: hidden; 
            display: flex; flex-direction: column; align-items: center; 
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 70%); 
            transition: background 0.5s;
        }

        .bg-lines { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.07; 
            background-image: 
                linear-gradient(to right, #ffffff 1px, transparent 1px), 
                linear-gradient(to bottom, #ffffff 1px, transparent 1px);
            background-size: 25px 25px; 
            animation: moveGrid 20s linear infinite;
        }
        @keyframes moveGrid { 0% { background-position: 0 0; } 100% { background-position: 0px 750px; } }

        /* --- Transitions --- */
        .user-avatar, .submit-btn, .menu-trigger, .custom-input:focus, 
        .amount-chip:hover, .amount-chip.active, .swal2-confirm, 
        .copy-result-btn:hover, .royal-logo, .crown-icon, .stat-box:hover, .input-wrapper i, .h-action-btn {
            transition: all var(--transition-speed) ease;
        }

        /* --- Header --- */
        .app-header { width: 100%; padding: 30px 20px; display: flex; justify-content: center; align-items: center; position: relative; }
        .royal-logo {
            font-size: 28px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; position: relative;
            background: linear-gradient(to right, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fcf6ba 75%, #bf953f 100%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 4s linear infinite; filter: drop-shadow(0 0 10px var(--primary-dim)); display: flex; align-items: center; gap: 10px; user-select: none;
        }
        body.theme-red .royal-logo { background: linear-gradient(to right, #d32f2f 0%, #ff5252 25%, #b71c1c 50%, #ff5252 75%, #d32f2f 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(255, 23, 68, 0.6)); }
        @keyframes shine { to { background-position: 300% center; } }
        .royal-logo:active { transform: scale(0.95); }
        .crown-icon { font-size: 26px; background: linear-gradient(to bottom, #ffd700, #b8860b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5)); }
        body.theme-red .crown-icon { background: linear-gradient(to bottom, #ff1744, #b71c1c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px #ff1744); }
        .spin-crown { animation: spin 1s ease-in-out; }
        @keyframes spin { 0% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.3); } 100% { transform: rotate(360deg) scale(1); } }
        .magic-particle { position: fixed; width: 50px; height: 50px; border-radius: 100%; pointer-events: none; z-index: 9999; }

        /* --- Main Card --- */
        .main-card { width: 90%; max-width: 450px; background: var(--card-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-light); border-radius: 30px; padding: 25px 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); position: relative; transition: transform 0.3s; }
        .card-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--border-light); position: relative; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar-wrapper { position: relative; width: 50px; height: 50px; }
        .user-avatar { width: 100%; height: 100%; background: linear-gradient(135deg, #333, #111); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid var(--primary); color: var(--primary); font-weight: 900; font-size: 18px; box-shadow: 0 0 10px var(--primary-dim); overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-text-col { display: flex; flex-direction: column; justify-content: center; }
        .name-row { display: flex; align-items: baseline; gap: 5px; }
        .user-greeting { font-size: 12px; color: #888; font-weight: 400; }
        .user-name { font-size: 15px; font-weight: 800; color: #fff; }
        .premium-badge { font-size: 10px; color: #000; background: linear-gradient(90deg, var(--primary), #fff, var(--primary)); background-size: 200% auto; animation: shine 3s linear infinite; padding: 3px 10px; border-radius: 20px; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; width: fit-content; margin-top: 2px; box-shadow: 0 0 8px var(--primary-dim); }
        .menu-container { position: relative; }
        .menu-trigger { width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-light); color: #fff; font-size: 18px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .menu-trigger:hover, .menu-trigger.active { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-dim); }
        .dropdown-menu { position: absolute; top: 50px; left: 0; width: 180px; background: #1a1a1a; border: 1px solid var(--border-light); border-radius: 15px; padding: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 100; }
        .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .menu-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #ccc; font-size: 14px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: white; padding-right: 20px; }
        .menu-item i { width: 20px; text-align: center; color: var(--primary); }
        .menu-item.danger:hover { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .menu-item.danger i { color: var(--danger); }
        .balance-section { text-align: center; margin-bottom: 20px; margin-top: 5px; position: relative; cursor: pointer; transition: transform 0.2s; }
        .balance-section:active { transform: scale(0.98); }
        .balance-label { font-size: 13px; color: var(--text-grey); display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 0px; }
        .balance-amount { font-size: 36px; font-weight: 900; color: white; text-shadow: 0 0 20px var(--primary-dim); letter-spacing: -1px; line-height: 1.2; }
        .inputs-area { display: flex; flex-direction: column; gap: 12px; margin-bottom: 10px; }
        .custom-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border-light); padding: 14px; border-radius: 15px; color: white; font-size: 16px; font-weight: 600; transition: 0.3s; text-align: center; }
        .custom-input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-dim); }
        .input-wrapper { position: relative; }
        .paste-badge { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.08); padding: 5px 10px; border-radius: 8px; font-size: 10px; cursor: pointer; color: #aaa; transition: 0.2s; z-index: 10; }
        .paste-badge:hover { background: var(--primary); color: #000; }
        .clear-badge:hover { background: rgba(231, 76, 60, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .chips-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px; }
        .amount-chip { background: rgba(255,255,255,0.03); border: 1px solid var(--border-light); border-radius: 12px; padding: 10px 0; text-align: center; font-size: 12px; font-weight: 700; color: #888; cursor: pointer; transition: 0.2s; }
        .amount-chip:hover { border-color: var(--primary); color: white; }
        .amount-chip.active { background: linear-gradient(135deg, var(--primary), #b8860b); color: #000; border: none; box-shadow: 0 5px 15px var(--primary-dim); }
        body.theme-red .amount-chip.active { background: linear-gradient(135deg, #ff1744, #b71c1c); }
        .submit-btn { width: 100%; padding: 16px; background: linear-gradient(90deg, var(--primary), #f3c200); border: none; border-radius: 15px; color: #000; font-size: 18px; font-weight: 900; cursor: pointer; box-shadow: 0 5px 20px var(--primary-dim); transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        body.theme-red .submit-btn { background: linear-gradient(90deg, #ff1744, #ff5252); color: white; }
        .submit-btn:active { transform: scale(0.98); }
        .price-tag { margin-top: 15px; text-align: center; font-size: 14px; color: var(--text-grey); }
        .price-tag span { color: white; font-weight: bold; font-size: 16px; }

        /* Login & Modals */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 5000; display: flex; justify-content: center; align-items: center; }
        .login-card { width: 85%; max-width: 350px; text-align: center; background: rgba(10, 10, 10, 0.85); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: #111; border: 1px solid var(--border-light); width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 80vh; overflow-y: auto; }

        /* Wallet New Styles */
        .wallet-card-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .wallet-title { color: #888; font-size: 14px; margin-bottom: 5px; }
        .wallet-balance-big { font-size: 40px; font-weight: 900; color: white; text-shadow: 0 0 20px var(--primary-dim); line-height: 1; }
        .wallet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .wallet-stat-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid var(--border-light); text-align: center; }
        .w-label { display: block; font-size: 11px; color: #888; margin-bottom: 5px; }
        .w-val { font-size: 16px; font-weight: bold; color: var(--primary); font-family: monospace; }
        .w-icon { font-size: 12px; margin-left: 5px; opacity: 0.5; }

        /* SweetAlert */
        div:where(.swal2-container) { z-index: 999999 !important; }
        div:where(.swal2-popup) { background: #111 !important; border: 1px solid rgba(212, 175, 55, 0.3) !important; border-radius: 20px !important; box-shadow: 0 25px 10px rgba(0,0,0,0.8) !important; padding: 30px 20px !important; width: 340px !important; }
        div:where(.swal2-title) { color: #fff !important; font-size: 18px !important; font-weight: 800 !important; margin-bottom: 10px !important; }
        div:where(.swal2-html-container) { color: #ccc !important; font-size: 14px !important; margin: 0 !important; line-height: 1.6; }
        div:where(.swal2-icon) { margin: 0 auto 8px auto !important; background: transparent !important; border-width: 2px !important; }
        div:where(.swal2-icon).swal2-question { border-color: var(--primary) !important; color: var(--primary) !important; box-shadow: 0 0 20px var(--primary-dim) !important; }
        div:where(.swal2-icon).swal2-question::before { color: var(--primary) !important; }
        button.swal2-confirm { background: linear-gradient(135deg, var(--primary), #b8860b) !important; color: #000 !important; font-weight: 800 !important; border-radius: 12px !important; padding: 10px 25px !important; font-size: 15px !important; border: none !important; flex: 1 !important; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 5px 15px var(--primary-dim) !important; }
        body.theme-red button.swal2-confirm { background: linear-gradient(135deg, #ff1744, #d32f2f) !important; color: white !important; }
        button.swal2-cancel { background: rgba(255,255,255,0.08) !important; color: #fff !important; border-radius: 12px !important; padding: 10px 25px !important; font-size: 15px !important; border: 1px solid rgba(255,255,255,0.1) !important; flex: 1 !important; }
        .copy-result-btn { margin-top: 15px; background: rgba(0,0,0,0.3); border: 1px dashed var(--border-light); color: #aaa; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .copy-result-btn:hover { border-color: var(--primary); color: var(--primary); background: rgba(212, 175, 55, 0.05); }

        /* Admin */
        .admin-dashboard-container { width: 100%; display: none; justify-content: center; padding: 20px 10px; }
        .admin-layout { display: grid; gap: 20px; width: 100%; max-width: 900px; }
        .admin-card { background: var(--card-glass); border: 1px solid var(--border-light); border-radius: 20px; padding: 20px; position: relative; overflow: hidden; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .admin-title { font-size: 18px; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid var(--border-light); transition: 0.3s; }
        .stat-box:hover { border-color: var(--primary); background: var(--primary-dim); }
        .stat-num { font-size: 28px; font-weight: 900; color: white; margin-top: 5px; }
        .stat-label { font-size: 12px; color: #aaa; }
        .admin-table-container { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border-light); }
        .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .admin-table th { background: rgba(255,255,255,0.05); padding: 12px; text-align: right; color: var(--primary); font-weight: bold; }
        .admin-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #ddd; }
        .ctrl-btn { border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; margin-left: 3px; }
        .btn-add { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .btn-sub { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .btn-del { background: transparent; border: 1px solid #444; color: #888; }
        .admin-input-group { display: flex; gap: 10px; margin-top: 10px; }
        .admin-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 10px; border-radius: 8px; color: white; font-size: 13px; }
        .admin-input:focus { border-color: var(--primary); }
        .admin-action-btn { background: var(--primary); border: none; color: black; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* History Cards */
        .history-list-container { display: flex; flex-direction: column; gap: 15px; padding-bottom: 20px; }
        .history-card { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 0; position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; animation: slideInUp 0.4s ease forwards; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .history-card:active { transform: scale(0.98); }
        .history-card::before { content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 4px; z-index: 2; }
        .history-card.success::before { background: var(--success); box-shadow: 2px 0 10px var(--success); }
        .history-card.wait::before { background: var(--warning); box-shadow: 2px 0 10px var(--warning); }
        .history-card.error::before { background: var(--danger); box-shadow: 2px 0 10px var(--danger); }
        .h-card-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .h-amount { font-size: 18px; font-weight: 800; color: white; display: flex; align-items: center; gap: 8px; text-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
        .h-amount i { color: var(--primary); font-size: 16px; }
        .h-status { font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .h-status.success { background: rgba(46, 204, 113, 0.1); color: var(--success); border: 1px solid rgba(46, 204, 113, 0.2); }
        .h-status.wait { background: rgba(241, 196, 15, 0.1); color: var(--warning); border: 1px solid rgba(241, 196, 15, 0.2); }
        .h-status.error { background: rgba(231, 76, 60, 0.1); color: var(--danger); border: 1px solid rgba(231, 76, 60, 0.2); }
        .h-card-body { padding: 15px; display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
        .h-info-group { display: flex; flex-direction: column; gap: 4px; }
        .h-label { font-size: 10px; color: #666; font-weight: bold; }
        .h-value { font-size: 13px; color: #ccc; font-family: monospace; letter-spacing: 0.5px; }
        
        .h-actions { display: flex; gap: 8px; }
        .h-action-btn { width: 35px; height: 35px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .h-action-btn:active { transform: scale(0.9); }
        .h-btn-print { color: var(--primary); }
        .h-btn-print:hover { background: var(--primary-dim); border-color: var(--primary); }
        .h-btn-copy:hover { background: rgba(255,255,255,0.1); color: white; }

        .h-card-footer { padding: 8px 15px; font-size: 10px; color: #555; background: rgba(0, 0, 0, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .h-api-msg { max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #777; }

        /* Receipt Template (Hidden) */
        #receipt-container {
            position: fixed; top: -9999px; left: -9999px; z-index: -1;
        }
        .receipt-card {
            width: 380px; background: #0a0a0a; border: 2px solid #d4af37; border-radius: 0; 
            padding: 30px 20px; font-family: 'Cairo', monospace; color: white; position: relative;
            background-image: radial-gradient(circle at 50% 50%, #151515 0%, #000 90%);
        }
        .receipt-header { text-align: center; border-bottom: 1px dashed #333; padding-bottom: 20px; margin-bottom: 20px; }
        .r-logo { font-size: 24px; color: #d4af37; font-weight: 900; margin-bottom: 5px; text-transform: uppercase; }
        .r-subtitle { font-size: 12px; color: #666; letter-spacing: 2px; }
        .r-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        .r-label { color: #888; }
        .r-val { font-weight: bold; font-family: monospace; font-size: 15px; }
        .r-total { border-top: 1px dashed #333; border-bottom: 1px dashed #333; padding: 15px 0; margin: 20px 0; display: flex; justify-content: space-between; align-items: center; }
        .r-total-label { font-size: 16px; font-weight: bold; color: #d4af37; }
        .r-total-val { font-size: 22px; font-weight: 900; color: white; }
        .r-footer { text-align: center; font-size: 11px; color: #444; margin-top: 30px; }
        .r-stamp {
            position: absolute; bottom: 80px; left: 30px; border: 3px double #2ecc71; color: #2ecc71;
            padding: 5px 15px; font-weight: 900; font-size: 18px; transform: rotate(-15deg); opacity: 0.8;
            text-transform: uppercase; border-radius: 5px;
        }

    </style>
</head>
<body>

    <div class="bg-lines"></div>

    <div id="receipt-container">
        <div id="final-receipt" class="receipt-card">
            <div class="receipt-header">
                <div class="r-logo"><i class="fas fa-crown"></i> BASHA STORE</div>
                <div class="r-subtitle">OFFICIAL RECEIPT</div>
            </div>
            <div class="r-row">
                <span class="r-label">Date</span>
                <span class="r-val" id="rec-date">---</span>
            </div>
            <div class="r-row">
                <span class="r-label">Order ID</span>
                <span class="r-val" id="rec-oid">---</span>
            </div>
            <div class="r-row">
                <span class="r-label">Player ID</span>
                <span class="r-val" id="rec-pid">---</span>
            </div>
            <div class="r-row">
                <span class="r-label">Agent</span>
                <span class="r-val" id="rec-agent">---</span>
            </div>
            
            <div class="r-total">
                <span class="r-total-label">TOKENS</span>
                <span class="r-total-val" id="rec-amount">0</span>
            </div>

            <div class="r-stamp">PAID</div>

            <div class="r-footer">
                THANK YOU FOR CHOOSING BASHA STORE<br>
                www.basha-store.com
            </div>
        </div>
    </div>
    <div id="login-view" class="login-overlay">
        <div class="login-card">
            <h1 style="color:var(--primary); font-size:40px; margin-bottom:10px; transition:color 0.5s;">الباشا</h1>
            <h3 style="color:white; margin-bottom:25px;">لشحن توكنز جواكر</h3>
            <div class="inputs-area">
                <input type="text" id="username" class="custom-input" placeholder="اسم المستخدم">
                <input type="password" id="password" class="custom-input" placeholder="كلمة المرور">
            </div>
            <button class="submit-btn" onclick="login()">دخول النظام</button>
        </div>
    </div>

    <div id="app-view" style="display:none; width: 100%;">
        
        <div class="app-header">
            <div class="royal-logo" onclick="toggleTheme(event)">
                <i class="fas fa-crown crown-icon" id="crown-el"></i>
                <span style="margin-right:8px;">وكيل جواكر المعتمد</span>
            </div>
        </div>

        <div style="display:flex; justify-content:center;">
            <div class="main-card">
                <div class="card-top-bar">
                    <div class="user-info">
                        
                        <div class="user-avatar-wrapper">
                            <div class="user-avatar" id="avatar-container">
                                <span id="user-initial">U</span>
                                <img id="user-img-tag" src="" alt="User" style="display:none;">
                            </div>
                        </div>

                        <div class="user-text-col">
                            <div class="name-row">
                                <span class="user-greeting" id="greeting-txt">مسالخير،</span>
                                <div class="user-name" id="display-username">User</div>
                            </div>
                            <div class="premium-badge">
                                مندوب معتمد
                                <i class="fas fa-check-circle verified-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="menu-container">
                        <button class="menu-trigger" onclick="toggleMenu()" id="menu-btn">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="dropdown-menu" id="main-dropdown">
                            <div class="menu-item" onclick="togglePrivacy()">
                                <i id="privacy-icon-menu" class="fas fa-eye-slash"></i>
                                <span id="privacy-text-menu">إخفاء الرصيد</span>
                            </div>
                            <div class="menu-item" onclick="openHistoryModal()">
                                <i class="fas fa-history"></i>
                                <span>سجل الشراء</span>
                            </div>
                            <div class="menu-item" onclick="openSettingsModal()">
                                <i class="fas fa-cog"></i>
                                <span>الإعدادات</span>
                            </div>
                            <div class="menu-divider" style="height:1px; background:rgba(255,255,255,0.1); margin:5px 0;"></div>
                            <div class="menu-item danger" onclick="logout()">
                                <i class="fas fa-power-off"></i>
                                <span>تسجيل خروج</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="balance-section" onclick="openWalletModal()">
                    <div class="balance-label">لديك توكنز</div>
                    <div class="balance-amount">
                        <span id="current-balance">0</span>
                    </div>
                </div>

                <div class="inputs-area">
                    <div class="input-wrapper">
                        <input type="number" id="player_id" class="custom-input" placeholder="رقم اللاعب" oninput="manualInput(this)" inputmode="numeric" pattern="[0-9]*">
                        <div class="paste-btn paste-badge" onclick="pasteID()"><i class="fas fa-paste"></i></div>
                    </div>
                    
                    <div class="input-wrapper">
                        <input type="text" id="amount_display" class="custom-input" placeholder="كمية التوكنز" oninput="manualInput(this)" inputmode="numeric" pattern="[0-9]*">
                        <div class="paste-btn paste-badge clear-badge" onclick="clearInputs()">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                    </div>

                </div>

                <div class="chips-container">
                    <div class="amount-chip" onclick="selectAmount(50000, this)">50K</div>
                    <div class="amount-chip" onclick="selectAmount(100000, this)">100K</div>
                    <div class="amount-chip" onclick="selectAmount(235000, this)">235K</div>
                    <div class="amount-chip" onclick="selectAmount(300000, this)">300K</div>
                    <div class="amount-chip" onclick="selectAmount(400000, this)">400K</div>
                    <div class="amount-chip" onclick="selectAmount(500000, this)">500K</div>
                    <div class="amount-chip" onclick="selectAmount(805000, this)">805K</div>
                    <div class="amount-chip" onclick="selectAmount(1000000, this)">1M</div>
                </div>

                <button class="submit-btn" onclick="submitUserOrder()">
                    <span>شراء</span>
                    <i class="fas fa-bolt"></i>
                </button>
                <div class="price-tag">سعر البيع المقترح: <span id="price-val">0.00$</span></div>
            </div>
        </div>
    </div>

    <div id="admin-view" class="admin-dashboard-container">
        <div class="admin-layout">
            
            <div class="admin-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="admin-title"><i class="fas fa-user-shield"></i> لوحة الإدارة</div>
                    <button onclick="logout()" style="background:var(--accent); border:none; color:white; padding:8px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">خروج</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">إجمالي العملاء</div>
                    <div id="total-users-count" class="stat-num">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">مجموع الأرصدة</div>
                    <div id="total-users-balance" class="stat-num" style="color:var(--primary);">0</div>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-header"><span class="admin-title" style="font-size:16px;">إضافة وكيل جديد</span></div>
                <div class="admin-input-group">
                    <input type="text" id="new-agent-name" placeholder="اسم المستخدم" class="admin-input">
                    <input type="text" id="new-agent-pass" placeholder="كلمة المرور" class="admin-input">
                    <button onclick="createNewUser()" class="admin-action-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-header"><span class="admin-title" style="font-size:16px;">قائمة الوكلاء</span></div>
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>الرصيد</th>
                                <th style="text-align:center;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="admin-card">
                <div class="admin-header"><span class="admin-title" style="font-size:16px;">ربط API</span></div>
                <input type="password" id="api-token" placeholder="API Token" class="admin-input" style="width:100%; margin-bottom:10px;">
                <div class="admin-input-group">
                    <input type="text" id="product-id" placeholder="Product ID (مثال: 364)" class="admin-input">
                    <button onclick="saveApiSettings()" class="admin-action-btn">حفظ</button>
                </div>
                <button onclick="openSearchModal()" style="width:100%; margin-top:15px; background:rgba(255,255,255,0.05); color:#ccc; border:1px solid #333; padding:10px; border-radius:8px; cursor:pointer;">بحث في المنتجات</button>
            </div>

        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h3>سجل العمليات</h3>
                <i class="fas fa-times" onclick="closeModal('history-modal')" style="cursor:pointer;"></i>
            </div>
            <input type="text" id="history-search" placeholder="بحث بالآيدي..." onkeyup="renderHistoryList()" style="width:100%; padding:10px; background:#222; border:none; color:white; border-radius:15px; margin-bottom:15px;">
            <div id="history-list" class="history-list-container"></div>
        </div>
    </div>

    <div id="wallet-modal" class="modal-overlay">
        <div class="modal-box" style="text-align:center; padding-top:0;">
            
            <div class="wallet-card-header">
                <div class="wallet-title">الرصيد الحالي</div>
                <div class="wallet-balance-big" id="wallet-modal-balance">0</div>
            </div>

            <div class="wallet-grid">
                <div class="wallet-stat-box">
                    <span class="w-label">مبيعات اليوم <i class="fas fa-calendar-day w-icon"></i></span>
                    <span class="w-val" id="wallet-today-sales">0</span>
                </div>
                <div class="wallet-stat-box">
                    <span class="w-label">إجمالي المبيعات <i class="fas fa-chart-line w-icon"></i></span>
                    <span class="w-val" id="wallet-total-sales">0</span>
                </div>
            </div>

            <button onclick="requestFunds()" style="background:#25d366; color:white; border:none; padding:15px; border-radius:12px; width:100%; font-weight:bold; font-size:16px; margin-bottom:15px;">
                <i class="fab fa-whatsapp"></i> طلب رصيد جديد
            </button>
            
            <div style="margin-top:20px; text-align:right;">
                <small style="color:#888;">آخر الحركات المالية:</small>
                <div id="wallet-history-list" style="margin-top:10px; border-top:1px solid rgba(255,255,255,0.05);"></div>
            </div>
            <button onclick="closeModal('wallet-modal')" style="margin-top:20px; background:none; border:none; color:#888; cursor:pointer;">إغلاق</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>الإعدادات</h3>
            <div style="margin-top:20px;">
                <button onclick="openAvatarModal()" style="width:100%; margin-bottom:15px; background:rgba(255,255,255,0.05); border:1px solid #333; padding:10px; border-radius:10px; color:#ccc; display:flex; align-items:center; justify-content:center; gap:8px;">
                    <i class="fas fa-user-circle" style="color:var(--primary);"></i>
                    تغيير الصورة الشخصية
                </button>

                <div style="border-top:1px solid rgba(255,255,255,0.1); margin:15px 0; padding-top:15px;">
                    <label style="font-size:12px; color:#888; display:block; margin-bottom:5px;">تخصيص السعر المقترح (لكل مليون)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="custom-price-input" placeholder="مثال: 115" style="flex:1; padding:10px; background:#222; border:1px solid #333; color:white; border-radius:10px;">
                        <button onclick="saveCustomPrice()" style="background:var(--primary); color:black; border:none; border-radius:10px; padding:0 15px; font-weight:bold;">حفظ</button>
                    </div>
                </div>

                <div style="border-top:1px solid rgba(255,255,255,0.1); margin:15px 0; padding-top:15px;">
                    <label style="font-size:12px; color:#888;">تغيير كلمة المرور</label>
                    <input type="password" id="new-user-pass-user" style="width:100%; padding:10px; background:#222; border:1px solid #333; color:white; border-radius:10px; margin-top:5px;">
                    <button onclick="changeUserPassword()" style="width:100%; margin-top:10px; background:rgba(255,255,255,0.1); border:1px solid #444; color:white; padding:10px; border-radius:10px; font-weight:bold;">تحديث الكلمة</button>
                </div>
            </div>
            <button onclick="closeModal('settings-modal')" style="width:100%; margin-top:10px; background:none; border:1px solid #333; color:#ccc; padding:10px; border-radius:10px;">إغلاق</button>
        </div>
    </div>

    <div id="avatar-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>تغيير الصورة الشخصية</h3>
            <p style="color:#888; font-size:12px; margin-top:5px;">ضع رابط الصورة (Direct Link) هنا:</p>
            <input type="text" id="avatar-url-input" placeholder="https://example.com/image.jpg" style="width:100%; padding:10px; background:#222; border:1px solid #333; color:white; border-radius:10px; margin-top:10px; direction:ltr; text-align:left;">
            
            <button onclick="saveAvatar()" style="width:100%; margin-top:15px; background:var(--primary); border:none; padding:10px; border-radius:10px; font-weight:bold; color:black;">حفظ الصورة</button>
            <button onclick="deleteAvatar()" style="width:100%; margin-top:10px; background:rgba(231, 76, 60, 0.2); border:none; padding:10px; border-radius:10px; font-weight:bold; color:var(--danger);">حذف الصورة (العودة للأصل)</button>
            <button onclick="closeModal('avatar-modal')" style="width:100%; margin-top:10px; background:none; border:1px solid #333; color:#ccc; padding:10px; border-radius:10px;">إغلاق</button>
        </div>
    </div>

    <div id="product-search-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>بحث عن منتج</h3>
            <input type="text" id="product-search-input" placeholder="اسم المنتج..." onkeyup="filterProducts()" style="width:100%; padding:10px; background:#222; border:none; color:white; border-radius:10px; margin-top:10px;">
            <div id="products-result-list" style="margin-top:15px;"></div>
            <button onclick="closeModal('product-search-modal')" style="width:100%; margin-top:10px; background:none; border:none; color:#888;">إغلاق</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // إعدادات الفايربيس
        const firebaseConfig = {
            apiKey: "AIzaSyDjvBAYZ_d-XcwxM0_lk_BctXUihTSdTMI",
            authDomain: "basha-store-32336.firebaseapp.com",
            databaseURL: "https://basha-store-32336-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "basha-store-32336",
            storageBucket: "basha-store-32336.firebasestorage.app",
            messagingSenderId: "68412758900",
            appId: "1:68412758900:web:e5ae77c755ebbe6d602a21"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = null;
        let currentPrice = localStorage.getItem('basha_custom_price') ? parseFloat(localStorage.getItem('basha_custom_price')) : 115;
        let privacyMode = false;
        let apiSettings = { token: '', productId: '' };

        // إعدادات المزود (BashaStore)
        const BashaApiBase = "https://api.bashastore.app";
        const ProxyUrl = "https://corsproxy.io/?";

        const Toast = Swal.mixin({
            toast: true,
            position: 'bottom',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        db.ref('settings').on('value', snap => { if(snap.val()) apiSettings = snap.val(); });

        // --- وظيفة توليد الفاتورة كصورة ---
        function generateReceipt(id, amount, orderId, dateStr) {
            document.getElementById('rec-date').innerText = dateStr.split(',')[0];
            document.getElementById('rec-oid').innerText = '#' + (orderId || '---');
            document.getElementById('rec-pid').innerText = id;
            document.getElementById('rec-agent').innerText = currentUser.username.toUpperCase();
            document.getElementById('rec-amount').innerText = parseInt(amount.replace(/,/g,'')).toLocaleString();

            const node = document.getElementById('final-receipt');

            Swal.fire({
                title: 'جاري إنشاء الإيصال...',
                didOpen: () => Swal.showLoading(),
                background: '#111',
                showConfirmButton: false,
                allowOutsideClick: false
            });

            html2canvas(node, {
                scale: 2,
                backgroundColor: null,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                Swal.fire({
                    title: 'إيصال العملية',
                    imageUrl: imgData,
                    imageWidth: 280,
                    imageAlt: 'Receipt',
                    background: '#111',
                    showConfirmButton: true,
                    confirmButtonText: '<i class="fas fa-download"></i> حفظ',
                    showCancelButton: true,
                    cancelButtonText: 'إغلاق',
                    customClass: { image: 'swal-receipt-img' }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const link = document.createElement('a');
                        link.download = `Basha_Receipt_${id}.png`;
                        link.href = imgData;
                        link.click();
                    }
                });
            });
        }

        // --- وظيفة البحث عن المنتجات (محدثة لـ BashaStore) ---
        function filterProducts() {
            const term = document.getElementById('product-search-input').value.toLowerCase();
            const list = document.getElementById('products-result-list');
            list.innerHTML = '<div style="text-align:center; color:#888;">جاري البحث...</div>';
            
            const token = document.getElementById('api-token').value;
            if(!token) { list.innerHTML = 'لا يوجد توكن'; return; }
            
            // الرابط النهائي: https://corsproxy.io/?https://api.bashastore.app/client/api/products
            const targetUrl = ProxyUrl + encodeURIComponent(BashaApiBase + "/client/api/products");
            
            fetch(targetUrl, {
                headers: {
                    'api-token': token,
                    'Accept': 'application/json'
                }
            })
            .then(r => r.json())
            .then(d => {
                list.innerHTML = '';
                // باشا ستور يُرجع المصفوفة مباشرة أو داخل data
                const products = Array.isArray(d) ? d : (d.data || []);

                if (!products || products.length === 0) {
                    list.innerHTML = '<div style="color:red; text-align:center;">لا توجد منتجات أو خطأ في التوكن</div>';
                    console.log("API Response:", d);
                    return;
                }

                const filtered = products.filter(x => x.name.toLowerCase().includes(term));
                
                if (filtered.length === 0) {
                     list.innerHTML = '<div style="text-align:center; color:#888;">لا توجد نتائج</div>';
                     return;
                }

                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.style.cssText = "padding:12px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between; align-items:center;";
                    div.innerHTML = `<span>${p.name}</span><span style="color:var(--primary); font-weight:bold;">$${p.price}</span>`;
                    div.onclick = () => { 
                        document.getElementById('product-id').value = p.id; 
                        closeModal('product-search-modal'); 
                        Toast.fire({icon:'success', title: `تم اختيار: ${p.name} (ID: ${p.id})`});
                    };
                    list.appendChild(div);
                });
            })
            .catch(e => {
                console.error(e);
                list.innerHTML = '<div style="color:var(--danger); text-align:center;">فشل الاتصال بالمزود</div>';
            });
        }

        // --- وظيفة إرسال الطلب (محدثة لـ BashaStore) ---
        function submitUserOrder() {
            const id = document.getElementById('player_id').value;
            const amtStr = document.getElementById('amount_display').value;
            const amt = parseInt(amtStr.replace(/,/g, ''));

            if(!id || !amt) return Toast.fire({icon:'warning', title:'يرجى إدخال الآيدي والكمية'});
            if((currentUser.balance||0) < amt) return Toast.fire({icon:'error', title:'عذراً، رصيدك غير كافٍ'});
            if(!apiSettings.token || !apiSettings.productId) return Toast.fire({icon:'error', title:'خطأ في إعدادات النظام'});

            Swal.fire({
                title: 'تأكيد العملية',
                html: `
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; border:1px solid #333; margin-top:5px;">
                        <div style="font-size:12px; color:#888;">الآيدي</div>
                        <div style="font-size:18px; font-weight:bold; color:white;">${id}</div>
                        <div style="height:1px; background:#333; margin:8px 0;"></div>
                        <div style="font-size:12px; color:#888;">الكمية</div>
                        <div style="font-size:18px; font-weight:bold; color:var(--primary);">${amtStr}</div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'شحن',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'جاري الشحن...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading() },
                        showConfirmButton: false 
                    });

                    const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); });
                    
                    // رابط الطلب حسب وثائق BashaStore
                    // /client/api/newOrder/{product_id}/params?qty={qty}&playerId={id}&order_uuid={uuid}
                    const apiUrl = `${BashaApiBase}/client/api/newOrder/${apiSettings.productId}/params?qty=${amt}&playerId=${id}&order_uuid=${uuid}`;
                    const targetUrl = ProxyUrl + encodeURIComponent(apiUrl);

                    fetch(targetUrl, { 
                        method:'GET', 
                        headers:{
                            'api-token': apiSettings.token,
                            'Accept': 'application/json'
                        } 
                    })
                    .then(r => r.json()).then(d => {
                        // التحقق من الاستجابة حسب الوثائق
                        /*
                        {
                            "status": "OK",
                            "data": {
                                "order_id": "...",
                                "status": "accept/wait",
                                "replay_api": [...]
                            }
                        }
                        */

                        if(d.status === 'OK' && d.data) {
                            const orderData = d.data;
                            const status = orderData.status; // accept, wait, reject
                            const orderId = orderData.order_id;
                            
                            // استخراج الرسالة
                            let apiMsg = 'تم إرسال الطلب';
                            try {
                                if (orderData.replay_api && Array.isArray(orderData.replay_api)) {
                                     // غالباً تكون في replay_api[0].replay[0]
                                     if (orderData.replay_api[0] && orderData.replay_api[0].replay) {
                                         apiMsg = orderData.replay_api[0].replay[0] || apiMsg;
                                     }
                                }
                            } catch(e){}

                            // خصم الرصيد وتسجيل العملية
                            db.ref('users/'+currentUser.username).transaction(u => {
                                if(u) {
                                    const oldB = u.balance || 0;
                                    const newB = oldB - amt;
                                    u.balance = newB;
                                    u.totalSales = (u.totalSales||0)+1;
                                    if(!u.history) u.history = [];
                                    u.history.unshift({
                                        type:'sale', 
                                        date:new Date().toLocaleString(), 
                                        amount:amtStr, 
                                        id:id, 
                                        orderId: orderId, 
                                        status: (status === 'wait') ? 'قيد المعالجة' : 'مكتمل', 
                                        apiRes: apiMsg, 
                                        before:oldB, 
                                        after:newB
                                    });
                                }
                                return u;
                            });

                            document.getElementById('amount_display').value = '';
                            document.getElementById('player_id').value = '';
                            calculate(0);
                            
                            Swal.fire({ 
                                icon: 'success', 
                                title: 'تمت العملية', 
                                html: `<div style="color:#ddd;">${apiMsg}</div>`,
                                confirmButtonText: 'موافق' 
                            });

                        } else {
                            // معالجة الأخطاء (مثل الرصيد غير كافي عند المزود)
                            const errCode = d.error_code || 'Error';
                            let errMsg = 'خطأ غير معروف';
                            
                            // ترجمة بعض أكواد الخطأ المشهورة من BashaStore
                            if (errCode == 100) errMsg = 'رصيد الحساب غير كافي (عند المزود)';
                            else if (errCode == 105) errMsg = 'الكمية غير متاحة';
                            else if (errCode == 120 || errCode == 121) errMsg = 'خطأ في التوكن';
                            else errMsg = `Code: ${errCode}`;

                            Swal.fire({ 
                                icon:'error', 
                                title:'فشل الطلب', 
                                text: errMsg,
                                confirmButtonText: 'إغلاق' 
                            });
                        }
                    }).catch(err => {
                        console.error(err);
                        Swal.fire({ icon:'error', title:'خطأ', text: 'فشل الاتصال بالمزود', confirmButtonText: 'إغلاق' });
                    });
                }
            });
        }

        // --- وظيفة تبديل الثيم ---
        let isRedTheme = false;
        function toggleTheme(e) {
            const crown = document.getElementById('crown-el');
            crown.classList.remove('spin-crown');
            void crown.offsetWidth; 
            crown.classList.add('spin-crown');

            isRedTheme = !isRedTheme;
            if (isRedTheme) { document.body.classList.add('theme-red'); } 
            else { document.body.classList.remove('theme-red'); }
            if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
            const color = isRedTheme ? '#ff1744' : '#ffd700';
            createMagicExplosion(e.clientX, e.clientY, color);
        }

        function createMagicExplosion(x, y, color) {
            const count = 30;
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.classList.add('magic-particle');
                particle.style.background = color;
                particle.style.boxShadow = `0 0 10px ${color}`;
                document.body.appendChild(particle);
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 100 + 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                const animation = particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], { duration: 800 + Math.random() * 400, easing: 'cubic-bezier(0, .9, .57, 1)' });
                animation.onfinish = () => particle.remove();
            }
        }

        function setGreeting() {
            const h = new Date().getHours();
            const g = h < 12 ? 'صباح الخير،' : 'مسالخير،';
            document.getElementById('greeting-txt').innerText = g;
        }

        function checkSession() {
            const savedUser = localStorage.getItem('basha_saved_user');
            if (savedUser) {
                document.getElementById('login-view').style.display = 'none';
                if (savedUser === 'admin') {
                    currentUser = 'admin';
                    document.getElementById('admin-view').style.display = 'flex';
                    loadAdminDashboard();
                } else {
                    db.ref('users/' + savedUser).once('value', snapshot => {
                        const user = snapshot.val();
                        if (user) {
                            currentUser = user;
                            currentUser.username = savedUser;
                            document.getElementById('app-view').style.display = 'block';
                            document.getElementById('display-username').innerText = savedUser;
                            document.getElementById('user-initial').innerText = savedUser.charAt(0).toUpperCase();
                            setGreeting();
                            updateAvatarUI();
                            updateUserUI();
                            db.ref('users/' + savedUser).on('value', s => {
                                if(s.val()) {
                                    currentUser = s.val();
                                    currentUser.username = savedUser;
                                    updateUserUI();
                                    updateAvatarUI();
                                }
                            });
                        } else {
                            localStorage.removeItem('basha_saved_user');
                            document.getElementById('login-view').style.display = 'flex';
                        }
                    });
                }
            } else {
                document.getElementById('login-view').style.display = 'flex';
            }
        }

        function toggleMenu() {
            const menu = document.getElementById('main-dropdown');
            const btn = document.getElementById('menu-btn');
            menu.classList.toggle('show');
            btn.classList.toggle('active');
        }

        document.addEventListener('click', function(event) {
            const menu = document.getElementById('main-dropdown');
            const btn = document.getElementById('menu-btn');
            const isClickInside = menu.contains(event.target) || btn.contains(event.target);
            if (!isClickInside && menu.classList.contains('show')) {
                menu.classList.remove('show');
                btn.classList.remove('active');
            }
        });

        function togglePrivacy() {
            privacyMode = !privacyMode;
            const icon = document.getElementById('privacy-icon-menu');
            const text = document.getElementById('privacy-text-menu');
            if (privacyMode) {
                icon.className = 'fas fa-eye';
                text.innerText = 'إظهار الرصيد';
            } else {
                icon.className = 'fas fa-eye-slash';
                text.innerText = 'إخفاء الرصيد';
            }
            updateUserUI();
            toggleMenu(); 
        }

        function openAvatarModal() {
            const menu = document.getElementById('main-dropdown');
            if(menu.classList.contains('show')) toggleMenu();
            document.getElementById('settings-modal').classList.remove('show');
            document.getElementById('avatar-modal').classList.add('show');
            document.getElementById('avatar-url-input').value = currentUser.avatar || '';
        }

        function saveAvatar() {
            const url = document.getElementById('avatar-url-input').value.trim();
            if(url) {
                db.ref('users/' + currentUser.username).update({ avatar: url });
                Toast.fire({icon: 'success', title: 'تم تحديث الصورة'});
                closeModal('avatar-modal');
            } else {
                Toast.fire({icon: 'warning', title: 'يرجى إدخال رابط صالح'});
            }
        }

        function deleteAvatar() {
            db.ref('users/' + currentUser.username).update({ avatar: null }); 
            Toast.fire({icon: 'success', title: 'تم حذف الصورة'});
            closeModal('avatar-modal');
        }

        function updateAvatarUI() {
            const img = document.getElementById('user-img-tag');
            const initial = document.getElementById('user-initial');
            if (currentUser && currentUser.avatar) {
                img.src = currentUser.avatar;
                img.style.display = 'block';
                initial.style.display = 'none';
            } else {
                img.style.display = 'none';
                initial.style.display = 'block';
                if(currentUser && currentUser.username) {
                    initial.innerText = currentUser.username.charAt(0).toUpperCase();
                }
            }
        }

        function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value;

            if (u === 'admin') {
                db.ref('settings/adminPass').once('value', snap => {
                    if (String(p) === String(snap.val() || 'Boos.saher')) {
                        localStorage.setItem('basha_saved_user', 'admin');
                        currentUser = 'admin';
                        document.getElementById('login-view').style.display = 'none';
                        document.getElementById('admin-view').style.display = 'flex';
                        loadAdminDashboard();
                    } else { 
                        Toast.fire({ icon: 'error', title: 'كلمة المرور غير صحيحة' }); 
                    }
                });
            } else {
                db.ref('users/' + u).once('value', snapshot => {
                    const user = snapshot.val();
                    if (user && String(user.password) === String(p)) {
                        localStorage.setItem('basha_saved_user', u);
                        currentUser = user;
                        currentUser.username = u;
                        document.getElementById('login-view').style.display = 'none';
                        document.getElementById('app-view').style.display = 'block';
                        document.getElementById('display-username').innerText = u;
                        document.getElementById('user-initial').innerText = u.charAt(0).toUpperCase();
                        setGreeting();
                        updateAvatarUI();
                        updateUserUI();

                        db.ref('users/' + u).on('value', s => {
                            if(s.val()) {
                                currentUser = s.val();
                                currentUser.username = u;
                                updateUserUI();
                                updateAvatarUI();
                            }
                        });
                        Toast.fire({ icon: 'success', title: `أهلاً بك يا ${u}` });
                    } else { 
                        Toast.fire({ icon: 'error', title: 'بيانات غير صحيحة' }); 
                    }
                });
            }
        }

        function logout() { 
            localStorage.removeItem('basha_saved_user'); 
            location.reload(); 
        }

        function updateUserUI() {
            const bal = (currentUser.balance || 0).toLocaleString();
            document.getElementById('current-balance').innerText = privacyMode ? '******' : bal;
            document.getElementById('wallet-modal-balance').innerText = bal;
        }

        async function pasteID() {
            try {
                const text = await navigator.clipboard.readText();
                if(text) { 
                    document.getElementById('player_id').value = text.replace(/[^0-9]/g, '');
                    Toast.fire({icon: 'success', title: 'تم اللصق'});
                }
            } catch(e) { 
                Toast.fire({icon: 'error', title: 'لم يتم السماح باللصق'}); 
            }
        }

        function clearInputs() {
            document.getElementById('player_id').value = '';
            document.getElementById('amount_display').value = '';
            document.querySelectorAll('.amount-chip').forEach(c => c.classList.remove('active'));
            calculate(0);
        }

        function selectAmount(val, elem) {
            document.querySelectorAll('.amount-chip').forEach(c => c.classList.remove('active'));
            if(elem) elem.classList.add('active');
            document.getElementById('amount_display').value = parseInt(val).toLocaleString('en-US');
            calculate(val);
        }

        function manualInput(input) {
            document.querySelectorAll('.amount-chip').forEach(c => c.classList.remove('active'));
            let val = input.value.replace(/[^0-9]/g, '');
            if(!val) { calculate(0); input.value = ''; return; }
            input.value = parseInt(val).toLocaleString('en-US');
            calculate(val);
        }

        function calculate(val) {
            document.getElementById('price-val').innerText = (val > 0 ? ((val/1000000)*currentPrice).toFixed(2) : "0.00") + '$';
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                Toast.fire({ icon: 'success', title: 'تم النسخ' });
            }).catch(() => {
                Toast.fire({ icon: 'error', title: 'فشل النسخ' });
            });
        }

        function openHistoryModal() {
            toggleMenu(); 
            document.getElementById('history-modal').classList.add('show');
            renderHistoryList();
        }

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            const q = document.getElementById('history-search').value.toLowerCase();
            list.innerHTML = '';
            
            let logs = (currentUser.history || []).filter(h => h.type === 'sale');
            if(q) logs = logs.filter(h => h.id.includes(q) || (h.orderId && h.orderId.toString().includes(q)));

            if(logs.length === 0) { 
                list.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#444; display:flex; flex-direction:column; align-items:center;">
                        <i class="fas fa-inbox" style="font-size:40px; margin-bottom:10px; opacity:0.3;"></i>
                        <span>لا توجد عمليات</span>
                    </div>`; 
                return; 
            }

            logs.forEach((h, index) => {
                let statusClass = 'wait';
                let statusIcon = 'fa-clock';
                let statusText = h.status;

                if (h.status.includes('مكتمل') || (h.apiRes && h.apiRes.includes('نجاح'))) { 
                    statusClass = 'success'; statusIcon = 'fa-check'; 
                } else if (h.status.includes('فشل') || (h.apiRes && h.apiRes.includes('فشل'))) { 
                    statusClass = 'error'; statusIcon = 'fa-times'; 
                }

                const item = document.createElement('div');
                item.style.animationDelay = `${index * 0.05}s`; 
                item.className = `history-card ${statusClass}`;
                
                const showPrint = statusClass === 'success' ? `
                    <button class="h-action-btn h-btn-print" onclick="generateReceipt('${h.id}', '${h.amount}', '${h.orderId}', '${h.date}')">
                        <i class="fas fa-file-image"></i>
                    </button>
                ` : '';

                item.innerHTML = `
                    <div class="h-card-header">
                        <div class="h-amount">
                            <i class="fas fa-gem"></i>
                            <span>${h.amount}</span>
                        </div>
                        <div class="h-status ${statusClass}">
                            <i class="fas ${statusIcon}"></i>
                            <span>${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="h-card-body">
                        <div class="h-info-group">
                            <span class="h-label">آيدي اللاعب</span>
                            <span class="h-value" style="color:white; font-size:15px;">${h.id}</span>
                            <span class="h-label" style="margin-top:5px;">رقم الطلب</span>
                            <span class="h-value">#${h.orderId || '---'}</span>
                        </div>
                        
                        <div class="h-actions">
                            ${showPrint}
                            <button class="h-action-btn h-btn-copy" onclick="copyToClipboard('${h.id}')">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <div class="h-card-footer">
                        <div class="h-api-msg">
                            <i class="fas fa-server" style="margin-left:3px;"></i> ${h.apiRes || 'النظام'}
                        </div>
                        <div style="font-family:arial;">${h.date.split(',')[0]}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function openWalletModal() {
            document.getElementById('wallet-modal').classList.add('show');
            const bal = (currentUser.balance || 0).toLocaleString();
            document.getElementById('wallet-modal-balance').innerText = bal;

            let todaySum = 0;
            let totalSum = 0;
            const todayStr = new Date().toLocaleDateString(); 

            if (currentUser.history) {
                currentUser.history.forEach(h => {
                    if (h.type === 'sale') {
                        const amt = parseInt(h.amount.toString().replace(/,/g, '')) || 0;
                        totalSum += amt;
                        if (h.date && h.date.includes(todayStr)) {
                            todaySum += amt;
                        }
                    }
                });
            }

            document.getElementById('wallet-today-sales').innerText = todaySum.toLocaleString();
            document.getElementById('wallet-total-sales').innerText = totalSum.toLocaleString();

            const list = document.getElementById('wallet-history-list');
            list.innerHTML = '';
            const logs = (currentUser.history||[]).filter(h => h.type==='in' || h.note);
            
            if(logs.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:10px; color:#555;">لا توجد حركات</div>';
            }
            
            logs.forEach(h => {
                const div = document.createElement('div');
                div.style.cssText = "display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #222; font-size:14px; align-items:center;";
                
                const isAdd = h.type === 'in';
                const color = isAdd ? '#2ecc71' : '#e74c3c';
                const icon = isAdd ? 'fa-arrow-down' : 'fa-arrow-up';
                const txt = isAdd ? 'شراء توكنز' : 'خصم إداري';

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:30px; height:30px; border-radius:50%; background:${color}20; color:${color}; display:flex; align-items:center; justify-content:center;">
                            <i class="fas ${icon}" style="font-size:12px;"></i>
                        </div>
                        <div style="display:flex; flex-direction:column;">
                            <span style="color:#ddd;">${txt}</span>
                            <span style="font-size:10px; color:#666;">${h.date}</span>
                        </div>
                    </div>
                    <span style="color:${color}; font-weight:bold; font-family:monospace;">${h.amount.toLocaleString()}</span>
                `;
                list.appendChild(div);
            });
        }
        
        function requestFunds() { window.open('https://wa.me/message/GTD2XYNG72ASI1', '_blank'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function openSettingsModal() { 
            toggleMenu(); 
            document.getElementById('settings-modal').classList.add('show'); 
            document.getElementById('custom-price-input').value = currentPrice;
        }
        
        function saveCustomPrice() {
            const p = document.getElementById('custom-price-input').value;
            if(p) {
                currentPrice = parseFloat(p);
                localStorage.setItem('basha_custom_price', currentPrice);
                Toast.fire({icon:'success', title: 'تم تحديث السعر المقترح'});
                const currentVal = document.getElementById('amount_display').value.replace(/,/g, '');
                if(currentVal) calculate(currentVal);
            }
        }

        function changeUserPassword() {
            const p = document.getElementById('new-user-pass-user').value;
            if(p) {
                db.ref('users/'+currentUser.username).update({password:p});
                closeModal('settings-modal');
                Toast.fire({icon:'success', title: 'تم تغيير كلمة المرور'});
            }
        }

        function loadAdminDashboard() {
            db.ref('users').on('value', snap => {
                const users = snap.val() || {};
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                let tc = 0, tb = 0;
                Object.keys(users).forEach(k => {
                    const u = users[k];
                    tc++; tb += (u.balance||0);
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="color:white; font-weight:bold;">${k}</td>
                        <td style="color:var(--primary); font-family:monospace;">${(u.balance||0).toLocaleString()}</td>
                        <td style="text-align:center;">
                            <button onclick="modifyBalance('${k}', 'add')" class="ctrl-btn btn-add">+</button>
                            <button onclick="modifyBalance('${k}', 'sub')" class="ctrl-btn btn-sub">-</button>
                            <button onclick="deleteUser('${k}')" class="ctrl-btn btn-del"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('total-users-count').innerText = tc;
                document.getElementById('total-users-balance').innerText = tb.toLocaleString();
            });
            document.getElementById('api-token').value = apiSettings.token || '';
            document.getElementById('product-id').value = apiSettings.productId || '';
        }

        function modifyBalance(k, t) {
            Swal.fire({title:t==='add'?'إضافة رصيد':'خصم رصيد', input:'number', showCancelButton:true}).then(r=>{
                if(r.value) {
                    const v = parseInt(r.value);
                    db.ref('users/'+k).transaction(u=>{
                        if(u) {
                            if(t==='add') { u.balance=(u.balance||0)+v; if(!u.history)u.history=[]; u.history.unshift({type:'in',amount:v,date:new Date().toLocaleString()}); }
                            else { u.balance=(u.balance||0)-v; if(!u.history)u.history=[]; u.history.unshift({type:'out',amount:v,date:new Date().toLocaleString(),note:'admin'}); }
                        } return u;
                    });
                    Toast.fire({icon:'success', title:'تم تحديث الرصيد'});
                }
            });
        }

        function createNewUser() {
            const n = document.getElementById('new-agent-name').value;
            const p = document.getElementById('new-agent-pass').value;
            if(n && p) {
                db.ref('users/'+n).set({password:p, balance:0, totalSales:0});
                document.getElementById('new-agent-name').value = '';
                document.getElementById('new-agent-pass').value = '';
                Toast.fire({icon:'success', title:'تم إضافة الوكيل'});
            }
        }

        function deleteUser(k) { 
            Swal.fire({title:'هل أنت متأكد؟', text:`سيتم حذف الوكيل ${k}`, icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', cancelButtonColor:'#3085d6', confirmButtonText:'حذف'}).then((result) => {
                if (result.isConfirmed) {
                    db.ref('users/'+k).remove();
                    Toast.fire({icon:'success', title:'تم الحذف'});
                }
            })
        }

        function saveApiSettings() { 
            db.ref('settings').update({
                token: document.getElementById('api-token').value, 
                productId: document.getElementById('product-id').value
            }); 
            Toast.fire({icon:'success', title: 'تم الحفظ'}); 
        }
        
        function openSearchModal() { document.getElementById('product-search-modal').classList.add('show'); }

        window.onload = checkSession;
    </script>
</body>
</html>
